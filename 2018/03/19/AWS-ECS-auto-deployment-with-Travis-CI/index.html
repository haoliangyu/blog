<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>AWS ECS continuous deployment with Travis CI | Joe&#39;s Talk</title><meta name="description" content><meta name="keywords" content><meta name="HandheldFriendly" content="True"><meta name="apple-mobile-web-app-capable" content="yes"><link rel="shortcut icon" href="/blog/"><link rel="alternate" href="/blog/atom.xml" title="Joe's Talk"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="This article discusses how to build a continuous deployment pipeline for an AWS ECS application using Travis CI."><meta name="keywords" content="aws,ci,deloyment"><meta property="og:type" content="article"><meta property="og:title" content="AWS ECS continuous deployment with Travis CI"><meta property="og:url" content="http://haoliangyu.github.io/blog/2018/03/19/AWS-ECS-auto-deployment-with-Travis-CI/index.html"><meta property="og:site_name" content="Joe&#39;s Talk"><meta property="og:description" content="This article discusses how to build a continuous deployment pipeline for an AWS ECS application using Travis CI."><meta property="og:locale" content="default"><meta property="og:updated_time" content="2018-04-22T04:00:00.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="AWS ECS continuous deployment with Travis CI"><meta name="twitter:description" content="This article discusses how to build a continuous deployment pipeline for an AWS ECS application using Travis CI."><link href="https://fonts.googleapis.com/css?family=Inconsolata|Titillium+Web" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet"><link href="//cdn.bootcss.com/node-waves/0.7.5/waves.min.css" rel="stylesheet"><link rel="stylesheet" href="/blog/style.css"><script>function setLoadingBarProgress(e){document.getElementById("loading-bar").style.width=e+"%"}</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-117921545-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-117921545-1")</script></head></html><body><div id="loading-bar-wrapper"><div id="loading-bar"></div></div><script>setLoadingBarProgress(20)</script><header class="l_header"><div class="wrapper"><div class="nav-main container container--flex"><a class="logo flat-box" href="/blog/">Joe's Talk</a><div class="menu"><ul class="h-list"><li><a class="flat-box nav-home" href="/blog/">Home</a></li><li><a class="flat-box nav-archives" href="/blog/archives">Archives</a></li></ul><div class="underline"></div></div><div class="m_search"><form name="searchform" class="form u-search-form"><input type="text" class="input u-search-input" placeholder="Search"> <span class="icon icon-search"></span></form></div><ul class="switcher h-list"><li class="s-search"><a href="javascript:void(0)"><span class="icon icon-search flat-box"></span></a></li><li class="s-menu"><a href="javascript:void(0)"><span class="icon icon-menu flat-box"></span></a></li></ul></div><div class="nav-sub container container--flex"><a class="logo" href="javascript:void(0)">Word of Forks</a><ul class="switcher h-list"><li class="s-comment"><a href="javascript:void(0)"><span class="icon icon-chat_bubble_outline flat-box"></span></a></li><li class="s-top"><a href="javascript:void(0)"><span class="icon icon-arrow_upward flat-box"></span></a></li><li class="s-toc"><a href="javascript:void(0)"><span class="icon icon-format_list_numbered flat-box"></span></a></li></ul></div></div></header><aside class="menu-phone"><nav><a href="/blog/" class="nav-home nav">Home </a><a href="/blog/archives" class="nav-archives nav">Archives</a></nav></aside><script>setLoadingBarProgress(40)</script><div class="l_body"><div class="container clearfix"><div class="l_main"><article id="post-AWS-ECS-auto-deployment-with-Travis-CI" class="post white-box article-type-post" itemscope itemprop="blogPost"><section class="meta"><h2 class="title"><a href="/blog/2018/03/19/AWS-ECS-auto-deployment-with-Travis-CI/">AWS ECS continuous deployment with Travis CI</a></h2><time>Mar 19, 2018</time><div class="cats"><a href="/blog/categories/AWS/">AWS</a></div></section><section class="toc-wrapper"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Problem"><span class="toc-number">1.</span> <span class="toc-text">Problem</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Script-Deployment-in-Travis-CI"><span class="toc-number">2.</span> <span class="toc-text">Script Deployment in Travis CI</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Deployment-Script"><span class="toc-number">3.</span> <span class="toc-text">Deployment Script</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Continuous-Deployment"><span class="toc-number">4.</span> <span class="toc-text">Continuous Deployment</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Final"><span class="toc-number">5.</span> <span class="toc-text">Final</span></a></li></ol></section><section class="article typo"><div class="article-entry" itemprop="articleBody"><p>This article discusses how to build a continuous deployment pipeline for an <a href="https://aws.amazon.com/ecs/" target="_blank" rel="noopener">AWS ECS</a> application using <a href="https://travis-ci.org" target="_blank" rel="noopener">Travis CI</a>.</p><a id="more"></a><h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>Deploying a docker-base application to the AWS ECS is a tedious task. It requires to push the image to an image repository, create a new task definition with that image, and update the service with the new definition. It is quick but repetitive.</p><p>In large organizations that have rapid deployment cycles, such tasks are usually taken care by CI/CD pipelines, like <a href="https://jenkins.io/index.html" target="_blank" rel="noopener">Jenkins</a>. But for a personal side project<a href="https://jenkins.io/index.html" target="_blank" rel="noopener">https://jenkins.io/index.html</a>, a dedicated CI/CD system is not affordable and it is an overkill lto use</p><p><a href="https://travis-ci.org" target="_blank" rel="noopener">Travis CI</a> is a continuous deployment service that provides free integration and service with public GitHub repositories. If you develop an open-source project at GitHub and add a <code>.travis.yml</code> file, Travis CI can connect with the repository and react to any code change.</p><p>This article assumes you have basic knowledge on AWS ECS and Travis CI.</p><h2 id="Script-Deployment-in-Travis-CI"><a href="#Script-Deployment-in-Travis-CI" class="headerlink" title="Script Deployment in Travis CI"></a>Script Deployment in Travis CI</h2><p>The requirement of the continuous deployment to AWS ECS is simple. Every time a pull request to the master branch is merged, the Travis CI should be noticed and perform the continuous deployment.</p><p>The deployment to AWS ECS requires custom operations and it is not automated by the Travis CI yet. To support sophisticated deployment operations, the Travis CI provides <a href="https://docs.travis-ci.com/user/deployment/script/" target="_blank" rel="noopener">Script Deployment</a> and it allows the developer to execute a specified script for deployment.</p><p>It can be activated by adding a new <code>deploy</code> section in the <code>.travis.yml</code> file in the project repository.</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># deployment section in the .travis.yml</span></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line"><span class="attr">  provider:</span> <span class="string">script</span></span><br><span class="line">  <span class="comment"># specify the deployment script</span></span><br><span class="line"><span class="attr">  script:</span> <span class="string">bash</span> <span class="string">deploy.sh</span></span><br><span class="line">  <span class="comment"># specify to deploy with code change a given branch</span></span><br><span class="line"><span class="attr">  on:</span></span><br><span class="line"><span class="attr">    branch:</span> <span class="string">develop</span></span><br></pre></td></tr></tbody></table></figure><h2 id="Deployment-Script"><a href="#Deployment-Script" class="headerlink" title="Deployment Script"></a>Deployment Script</h2><p>The next step is to define tasks for the deployment. We would like to define more repetitive tasks for the Travis CI and leave the most important action to the developer, like clicking the <code>Merge</code> button at the GitHub PR.</p><p>Specifically, these steps are required:</p><ol><li>build the docker image from the source code</li><li>tag the docker image as <code>latest</code></li><li>push the docker image to an image repository</li><li>update the AWS ECS application with the new image</li></ol><p>The first three steps could be done with the <a href="https://docs.docker.com/engine/reference/commandline/cli/" target="_blank" rel="noopener">docker CLI</a>. The fourth step actually includes many interactions with AWS, but a very nice library called <a href="https://github.com/silinternational/ecs-deploy" target="_blank" rel="noopener">ecs-deploy</a> could do all things with one line of command!</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># install AWS SDK</span></span><br><span class="line">pip install --user awscli</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$HOME</span>/.<span class="built_in">local</span>/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># install necessary dependency for ecs-deploy</span></span><br><span class="line">add-apt-repository ppa:eugenesan/ppa</span><br><span class="line">apt-get update</span><br><span class="line">apt-get install jq -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># install ecs-deploy</span></span><br><span class="line">curl https://raw.githubusercontent.com/silinternational/ecs-deploy/master/ecs-deploy | \</span><br><span class="line">  sudo tee -a /usr/bin/ecs-deploy</span><br><span class="line">sudo chmod +x /usr/bin/ecs-deploy</span><br><span class="line"></span><br><span class="line"><span class="comment"># login AWS ECR</span></span><br><span class="line"><span class="built_in">eval</span> $(aws ecr get-login --region us-east-1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># or login DockerHub</span></span><br><span class="line"><span class="comment"># docker login --username $DOCKER_HUB_USER --password $DOCKER_HUB_PSW</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># build the docker image and push to an image repository</span></span><br><span class="line">docker build -t haoliangyu/ecs-auto-deploy .</span><br><span class="line">docker tag haoliangyu/ecs-auto-deploy:latest <span class="variable">$IMAGE_REPO_URL</span>:latest</span><br><span class="line">docker push <span class="variable">$IMAGE_REPO_URL</span>:latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># update an AWS ECS service with the new image</span></span><br><span class="line">ecs-deploy -c <span class="variable">$CLUSTER_NAME</span> -n <span class="variable">$SERVICE_NAME</span> -i <span class="variable">$IMAGE_REPO_URL</span>:latest</span><br></pre></td></tr></tbody></table></figure><p>All <code>$VARIABLE_NAME</code> in the deployment script refer to an environment variable. Except <code>PATH</code> and <code>HOME</code>, which are provided by the operation system, you should provide the rest of them:</p><ul><li><code>IMAGE_REPO_URL</code> is the url of a docker image repository. It could be <a href="https://hub.docker.com/" target="_blank" rel="noopener">DockerHub</a> repository name or <a href="https://aws.amazon.com/ecr" target="_blank" rel="noopener">AWS ECR</a> repository url, or any other.</li><li><code>CLUSTER_NAME</code> is the name of the running ECS cluster.</li><li><code>SERVICE_NAME</code> is the name of the running ECS service.</li></ul><p>These values could be hard-coded, but using an environment variable makes the script more secure and portable.</p><p>Note that <code>ecs-deploy</code> deploys to an existing ECS service. If the specified service is not created, it will not try to new one and throw an error instead.</p><h2 id="Continuous-Deployment"><a href="#Continuous-Deployment" class="headerlink" title="Continuous Deployment"></a>Continuous Deployment</h2><p>With the deployment script discussed above, we can write the Travis CI configuration <code>.travis.yml</code>.</p><figure class="highlight yaml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># I am using a nodejs for my demo application</span></span><br><span class="line"><span class="attr">language:</span> <span class="string">node_js</span></span><br><span class="line"><span class="attr">node_js:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">"node"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># include the docker service so that we can use the docker command in</span></span><br><span class="line"><span class="comment"># the deployment script</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">docker</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># same as the official documentation</span></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line"><span class="attr">  provider:</span> <span class="string">script</span></span><br><span class="line"><span class="attr">  script:</span> <span class="string">bash</span> <span class="string">deploy.sh</span></span><br><span class="line"><span class="attr">  on:</span></span><br><span class="line"><span class="attr">branch:</span> <span class="string">master</span></span><br></pre></td></tr></tbody></table></figure><p>The configuration is pretty much the same as the one from the documentation. It requires the <code>docker</code> service for the docker command line tool.</p><p>Then you should add required environment variables in the <code>Settings</code> page of the Travis repository. Additionally, <code>AWS_ACCESS_KEY_ID</code>, <code>AWS_SECRET_ACCESS_KEY</code>, and <code>AWS_DEFAULT_REGION</code> are needed to help accessing AWS.</p><h2 id="Final"><a href="#Final" class="headerlink" title="Final"></a>Final</h2><p>Wow, you are done here <span class="github-emoji" style="display:inline;vertical-align:middle;margin:0 3px;color:transparent;background:no-repeat url(https://assets-cdn.github.com/images/icons/emoji/unicode/1f389.png?v8) center/contain" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f389.png?v8">üéâ</span> With this setting, you will have a continuous deployment pipeline that reacts to any PR merged into the master branch. And it deploys :-)</p><p>Thank you for reading this blog post. All code in this post could be found in this <a href="https://github.com/haoliangyu/ecs-auto-deploy" target="_blank" rel="noopener">GitHub repository</a> (<span class="github-emoji" style="display:inline;vertical-align:middle;margin:0 3px;color:transparent;background:no-repeat url(https://assets-cdn.github.com/images/icons/emoji/unicode/2b50.png?v8) center/contain" data-src="https://assets-cdn.github.com/images/icons/emoji/unicode/2b50.png?v8">‚≠ê</span> it if it helps) and it is <a href="https://travis-ci.org/haoliangyu/ecs-auto-deploy" target="_blank" rel="noopener">working</a>.</p><script>document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });</script></div><div class="article-tags tags"><a href="/blog/tags/aws/">aws</a> <a href="/blog/tags/ci/">ci</a> <a href="/blog/tags/deloyment/">deloyment</a></div><div class="art-item-footer"><span class="art-item-right">nextÔºö<a href="/blog/2017/02/11/The-unofficial-documentation-for-ArcGIS-Open-Data-dataset-search-API/" rel="next" title="The unofficial documentation for ArcGIS Open Data APIs"> The unofficial documentation for ArcGIS Open Data APIs </a><i class="icon icon-chevron-thin-right"></i></span></div></section><section id="comments"><div id="disqus_thread"></div></section></article><script>window.subData={title:"AWS ECS continuous deployment with Travis CI",tools:!0}</script></div><aside class="l_side"><section class="m_widget about"><div class="header">Haoliang Yu</div><div class="content"><div class="desc">I am a software engineer at Esri DC R&amp;D, working on open data publication and discovery. I love to play with data, cloud computing, and distributed network. I also co-organize MaptimeBUF and speak at variou meetups/conferences.</div></div></section><section class="m_widget links"><div class="header">Links</div><div class="content"><ul class="entry"><li><a class="flat-box" target="_blank" href="https://github.com/haoliangyu"><div class="name">GitHub</div></a></li><li><a class="flat-box" target="_blank" href="https://www.linkedin.com/in/haoliangyu/"><div class="name">LinkedIn</div></a></li><li><a class="flat-box" target="_blank" href="http://dc.esri.com/"><div class="name">EsriDC</div></a></li></ul></div></section><section class="m_widget categories"><div class="header">Categories</div><div class="content"><ul class="entry"><li><a class="flat-box" href="/blog/categories/AWS/"><div class="name">AWS</div><div class="badget">1</div></a></li><li><a class="flat-box" href="/blog/categories/GIS/"><div class="name">GIS</div><div class="badget">14</div></a></li><li><a class="flat-box" href="/blog/categories/Life/"><div class="name">Life</div><div class="badget">1</div></a></li><li><a class="flat-box" href="/blog/categories/Open-Data/"><div class="name">Open Data</div><div class="badget">1</div></a></li><li><a class="flat-box" href="/blog/categories/Project/"><div class="name">Project</div><div class="badget">4</div></a></li></ul></div></section><div class="m_widget tagcloud"><div class="header">Tags</div><div class="content"><a href="/blog/tags/C/" style="font-size:14px;color:grey">C#</a> <a href="/blog/tags/OpenDataDiscovery-org/" style="font-size:15.2px;color:#666">OpenDataDiscovery.org</a> <a href="/blog/tags/arcgis/" style="font-size:18.8px;color:#1a1a1a">arcgis</a> <a href="/blog/tags/arcobject/" style="font-size:14px;color:grey">arcobject</a> <a href="/blog/tags/aws/" style="font-size:14px;color:grey">aws</a> <a href="/blog/tags/ci/" style="font-size:14px;color:grey">ci</a> <a href="/blog/tags/deloyment/" style="font-size:14px;color:grey">deloyment</a> <a href="/blog/tags/geojson/" style="font-size:15.2px;color:#666">geojson</a> <a href="/blog/tags/gis/" style="font-size:20px;color:#000">gis</a> <a href="/blog/tags/javascript/" style="font-size:15.2px;color:#666">javascript</a> <a href="/blog/tags/landsat/" style="font-size:15.2px;color:#666">landsat</a> <a href="/blog/tags/leaflet/" style="font-size:16.4px;color:#4d4d4d">leaflet</a> <a href="/blog/tags/modis/" style="font-size:14px;color:grey">modis</a> <a href="/blog/tags/open-data/" style="font-size:17.6px;color:#333">open data</a> <a href="/blog/tags/openstreetmap/" style="font-size:14px;color:grey">openstreetmap</a> <a href="/blog/tags/project/" style="font-size:16.4px;color:#4d4d4d">project</a> <a href="/blog/tags/python/" style="font-size:16.4px;color:#4d4d4d">python</a> <a href="/blog/tags/remote-sensing/" style="font-size:17.6px;color:#333">remote sensing</a> <a href="/blog/tags/typescript/" style="font-size:16.4px;color:#4d4d4d">typescript</a></div></div></aside><script>setLoadingBarProgress(60)</script></div></div><footer id="footer" class="clearfix"><div class="social-wrapper"><a href="https://github.com/haoliangyu" class="social github" target="_blank" rel="external"><span class="icon icon-github"></span> </a><a href="/atom.xml" class="social rss" target="_blank" rel="external"><span class="icon icon-rss"></span></a></div><div>A blog built by Haoliang Yu</div></footer><script>setLoadingBarProgress(80)</script><script>var disqus_shortname="dz316424",disqus_url="http://haoliangyu.github.io/blog/2018/03/19/AWS-ECS-auto-deployment-with-Travis-CI/";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script><script src="//cdn.bootcss.com/node-waves/0.7.5/waves.min.js"></script><script src="//cdn.bootcss.com/scrollReveal.js/3.3.2/scrollreveal.min.js"></script><script src="/blog/js/jquery.fitvids.js"></script><script>var GOOGLE_CUSTOM_SEARCH_API_KEY="",GOOGLE_CUSTOM_SEARCH_ENGINE_ID="",ALGOLIA_API_KEY="",ALGOLIA_APP_ID="",ALGOLIA_INDEX_NAME="",AZURE_SERVICE_NAME="",AZURE_INDEX_NAME="",AZURE_QUERY_KEY="",BAIDU_API_ID="",SEARCH_SERVICE="hexo",ROOT="/blog/";ROOT.endsWith("/")||(ROOT+="/")</script><script src="/blog/js/search.js"></script><script src="/blog/js/app.js"></script><script>setLoadingBarProgress(100)</script></body>