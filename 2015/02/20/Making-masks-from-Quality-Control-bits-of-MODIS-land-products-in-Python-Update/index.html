<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Making masks from Quality Control bits of MODIS land products in Python (Update) | Distributed Knowledge</title><meta name="description" content=""><meta name="keywords" content=""><meta name="HandheldFriendly" content="True"><meta name="apple-mobile-web-app-capable" content="yes"><link rel="shortcut icon" href="/blog/"><link rel="alternate" href="/blog/atom.xml" title="Distributed Knowledge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="Update Since 0.3.0, most class and function names have been updated according to pep8.Days ago when I published the first version of pymasker for masking Landsat 8 image, Dr. Robert A. Washington-Alle"><meta name="keywords" content="remote sensing,modis,python"><meta property="og:type" content="article"><meta property="og:title" content="Making masks from Quality Control bits of MODIS land products in Python (Update)"><meta property="og:url" content="http://haoliangyu.github.io/blog/2015/02/20/Making-masks-from-Quality-Control-bits-of-MODIS-land-products-in-Python-Update/index.html"><meta property="og:site_name" content="Distributed Knowledge"><meta property="og:description" content="Update Since 0.3.0, most class and function names have been updated according to pep8.Days ago when I published the first version of pymasker for masking Landsat 8 image, Dr. Robert A. Washington-Alle"><meta property="og:updated_time" content="2018-03-03T20:45:36.118Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Making masks from Quality Control bits of MODIS land products in Python (Update)"><meta name="twitter:description" content="Update Since 0.3.0, most class and function names have been updated according to pep8.Days ago when I published the first version of pymasker for masking Landsat 8 image, Dr. Robert A. Washington-Alle"><link href="https://fonts.googleapis.com/css?family=Inconsolata|Titillium+Web" rel="stylesheet"><link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel="stylesheet"><link href="//cdn.bootcss.com/node-waves/0.7.5/waves.min.css" rel="stylesheet"><link rel="stylesheet" href="/blog/style.css"><script>function setLoadingBarProgress(e){document.getElementById("loading-bar").style.width=e+"%"}</script></head></html><body><div id="loading-bar-wrapper"><div id="loading-bar"></div></div><script>setLoadingBarProgress(20)</script><header class="l_header"><div class="wrapper"><div class="nav-main container container--flex"><a class="logo flat-box" href="/blog/">Distributed Knowledge</a><div class="menu"><ul class="h-list"><li><a class="flat-box nav-home" href="/blog/">Home</a></li><li><a class="flat-box nav-archives" href="/blog/archives">Archives</a></li></ul><div class="underline"></div></div><div class="m_search"><form name="searchform" class="form u-search-form"><input type="text" class="input u-search-input" placeholder="Search"> <span class="icon icon-search"></span></form></div><ul class="switcher h-list"><li class="s-search"><a href="javascript:void(0)"><span class="icon icon-search flat-box"></span></a></li><li class="s-menu"><a href="javascript:void(0)"><span class="icon icon-menu flat-box"></span></a></li></ul></div><div class="nav-sub container container--flex"><a class="logo" class="flat-box" href="javascript:void(0)">Word of Forks</a><ul class="switcher h-list"><li class="s-comment"><a href="javascript:void(0)"><span class="icon icon-chat_bubble_outline flat-box"></span></a></li><li class="s-top"><a href="javascript:void(0)"><span class="icon icon-arrow_upward flat-box"></span></a></li><li class="s-toc"><a href="javascript:void(0)"><span class="icon icon-format_list_numbered flat-box"></span></a></li></ul></div></div></header><aside class="menu-phone"><nav><a href="/blog/" class="nav-home nav">Home </a><a href="/blog/archives" class="nav-archives nav">Archives</a></nav></aside><script>setLoadingBarProgress(40)</script><div class="l_body"><div class="container clearfix"><div class="l_main"><article id="post-Making-masks-from-Quality-Control-bits-of-MODIS-land-products-in-Python-Update" class="post white-box article-type-post" itemscope itemprop="blogPost"><section class="meta"><h2 class="title"><a href="/blog/2015/02/20/Making-masks-from-Quality-Control-bits-of-MODIS-land-products-in-Python-Update/">Making masks from Quality Control bits of MODIS land products in Python (Update)</a></h2><time>Feb 20, 2015</time><div class="cats"><a href="/blog/categories/GIS/">GIS</a></div></section><section class="toc-wrapper"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#MODIS-QC-QA-bits"><span class="toc-number">1.</span> <span class="toc-text">MODIS QC/QA bits</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Preparation"><span class="toc-number">2.</span> <span class="toc-text">Preparation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Maksing-for-MODIS-product"><span class="toc-number">3.</span> <span class="toc-text">Maksing for MODIS product</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Update"><span class="toc-number">4.</span> <span class="toc-text">Update</span></a></li></ol></section><section class="article typo"><div class="article-entry" itemprop="articleBody"><p><strong>Update</strong> Since 0.3.0, most class and function names have been updated according to pep8.</p><p>Days ago when I published the first version of <em><a href="https://github.com/haoliangyu/pymasker" target="_blank" rel="noopener">pymasker</a></em> for masking Landsat 8 image, Dr. Robert A. Washington-Allen suggested me whether the package would be used for MODIS products. After I read technical documents of MODIS, I realize that the Quality Control bits of MOIDS products has the same structure as the QA band of Landsat 8. Therefore, I update the package to adapt MODIS products (or other NASA products with similar QC/QA bits).<br><a id="more"></a><br>In this article, I am going to show how to extract masks from the Quality Control bits of MODIS land product in python.</p><h2 id="MODIS-QC-QA-bits"><a href="#MODIS-QC-QA-bits" class="headerlink" title="MODIS QC/QA bits"></a>MODIS QC/QA bits</h2><hr><p>The QC/QA bits of MODIS is a binary number, of which each section represents the state of certain condition. Just take the 250m resolution land surface reflectance product (MOD09GQ) as example. The QC band (maybe called QA band in other products) is the fourth band of the HDF dataset. It is a unsigned 16-bit band. Each value on the pixel indicates a combination of pixel conditions. We can interpret the value by separating its binary form.</p><p>The individual bits within a binary number are read from let to right as described in the following table.</p><p>Therefore when we put the interpretation back to the bit string, we are able to know what it indicates.</p><p>As this binary number is 4096 in integer, all pixels having value 4096 in the QC band are high quality and cloud free with atmosphere correction, but no adjacency correction.</p><p>The structure of QC/QA bits vary in different MODISO products and different data collection. For full detail for each product, please have a look at</p><ul><li><a href="https://lpdaac.usgs.gov/products/modis_products_table" target="_blank" rel="noopener">MODIS Land Products QA Tutorial</a></li></ul><p>In the next sections, I will show how to make masks based on the QC/QA bits in python.</p><h2 id="Preparation"><a href="#Preparation" class="headerlink" title="Preparation"></a>Preparation</h2><hr><p>Before getting started, you need to do the following preparations:</p><ul><li><p>Download and install <strong><a href="https://github.com/haoliangyu/pymasker" target="_blank" rel="noopener">pymasker</a></strong>.</p></li><li><p>Know the band number of QC/QA band in your HDF dataset.</p></li><li><p>Know the QC/QA bit structure of your dataset. If you only want the mask of quality level, you don’t have to know the bit structure. Please go bottom and read the new update.</p></li></ul><h2 id="Maksing-for-MODIS-product"><a href="#Maksing-for-MODIS-product" class="headerlink" title="Maksing for MODIS product"></a>Maksing for MODIS product</h2><hr><p>I will continue to use MOD09GQ in the sample. First you need to load the QC Band</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pymasker <span class="keyword">import</span> Masker</span><br><span class="line"></span><br><span class="line"><span class="comment"># Directly load from file, require GDAL (3 is the QA band number)</span></span><br><span class="line">masker = Masker(<span class="string">'MOD09GQ.A2015025.h12v04.005.2015027064556.hdf'</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Or you just load the dataset somewhere and get the band data as numpy array</span></span><br><span class="line"><span class="keyword">import</span> gdal</span><br><span class="line"></span><br><span class="line">hdfdataset = gdal.Open(<span class="string">'MOD09GQ.A2015025.h12v04.005.2015027064556.hdf'</span>)</span><br><span class="line">subdataset = hdfdataset.GetSubDatasets()[<span class="number">3</span>][<span class="number">0</span>]</span><br><span class="line">bandarray = gdal.Open(subdataset).ReadAsArray()</span><br><span class="line"></span><br><span class="line">masker = Masker(bandarray)</span><br></pre></td></tr></table></figure><p>You need to know the bit information to generate certain masks. For example, we want a mask only wit high quality pixels. In the previous section we have known that the quality bits start at the beginning (position 0) and the length is 2. We also know that <em>‘00’</em> indicate corrected product produced at ideal quality in all bands. Therefore, the high quality mask could be made with</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Get high quality mask</span></span><br><span class="line">mask = modismasker.ge_tmask(bitpos = <span class="number">0</span>, bitlen = <span class="number">2</span>, value = <span class="string">'00'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Save the mask as a TIF file</span></span><br><span class="line">masker.save_tif(hqmask, <span class="string">'result.tif'</span>)</span><br></pre></td></tr></table></figure><p>Then you can get a binary mask where 1 represents the high quality pixel.</p><h2 id="Update"><a href="#Update" class="headerlink" title="Update"></a>Update</h2><p><em>Pyamsker</em> has provided a new class for producing QA mask since version 0.2.2. So you don’t have to look for and remember those binary bits (Well I don’t like them, too).</p><p>I have wrapped quality levels for MODIS land products.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pymasker <span class="keyword">import</span> ModisQuality</span><br><span class="line"></span><br><span class="line"><span class="comment"># Corrected product produced at ideal quality for all bands.</span></span><br><span class="line">quality = ModisQuality.high</span><br><span class="line"></span><br><span class="line"><span class="comment"># Corrected product produced at less than ideal quality for some or all bands.</span></span><br><span class="line">quality = ModisQuality.medium</span><br><span class="line"></span><br><span class="line"><span class="comment"># Corrected product not produced due to some reasons for some or all bands.</span></span><br><span class="line">quality = ModisQuality.low</span><br><span class="line"></span><br><span class="line"><span class="comment"># Corrected product not produced due to cloud effects for all bands.</span></span><br><span class="line">quality = ModisQuality.low_cloud</span><br></pre></td></tr></table></figure><p>Therefore, the masking code would be very intuitive and readable.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Create a MODIS QA masker, similar to creating a masker above</span></span><br><span class="line"><span class="keyword">from</span> pymasker <span class="keyword">import</span> ModisMasker</span><br><span class="line"></span><br><span class="line">masker = ModisMasker(<span class="string">'MOD09GQ.A2015025.h12v04.005.2015027064556.hdf'</span>)</span><br><span class="line">mask = masker.get_qa_mask(ModisQuality.high)</span><br></pre></td></tr></table></figure><p>I am going to gradually support all MODIS products in the future release. Please look forward to my new update :)</p></div><div class="article-tags tags"><a href="/blog/tags/remote-sensing/">remote sensing</a> <a href="/blog/tags/modis/">modis</a> <a href="/blog/tags/python/">python</a></div><div class="art-item-footer"><span class="art-item-left"><i class="icon icon-chevron-thin-left"></i>prev：<a href="/blog/2015/03/12/Yet-another-way-to-edit-your-raster-layer-in-ArcMap-Paint-on-it/" rel="prev" title="Yet another way to edit your raster layer in ArcMap - Paint on it!"> Yet another way to edit your raster layer in ArcMap - Paint on it! </a></span><span class="art-item-right">next：<a href="/blog/2015/02/18/Editing-single-pixels-of-raster-layer-in-ArcMap-with-just-a-few-clicks/" rel="next" title="Editing single pixels of raster layer in ArcMap with just a few clicks"> Editing single pixels of raster layer in ArcMap with just a few clicks </a><i class="icon icon-chevron-thin-right"></i></span></div></section></article><script>window.subData={title:"Making masks from Quality Control bits of MODIS land products in Python (Update)",tools:!0}</script></div><aside class="l_side"><section class="m_widget about"><div class="header">Haoliang Yu</div><div class="content"><div class="desc">I am a software engineer at Esri DC R&amp;D, working on open data publication and discovery. I love to play with data, cloud computing, and distributed network. I also co-organize MaptimeBUF and speak at variou meetups/conferences.</div></div></section><section class="m_widget links"><div class="header">Links</div><div class="content"><ul class="entry"><li><a class="flat-box" target="_blank" href="https://github.com/haoliangyu"><div class="name">GitHub</div></a></li><li><a class="flat-box" target="_blank" href="https://www.linkedin.com/in/haoliangyu/"><div class="name">LinkedIn</div></a></li><li><a class="flat-box" target="_blank" href="http://dc.esri.com/"><div class="name">EsriDC</div></a></li></ul></div></section><section class="m_widget categories"><div class="header">Categories</div><div class="content"><ul class="entry"><li><a class="flat-box" href="/blog/categories/GIS/"><div class="name">GIS</div><div class="badget">14</div></a></li><li><a class="flat-box" href="/blog/categories/Life/"><div class="name">Life</div><div class="badget">1</div></a></li><li><a class="flat-box" href="/blog/categories/Open-Data/"><div class="name">Open Data</div><div class="badget">1</div></a></li><li><a class="flat-box" href="/blog/categories/Project/"><div class="name">Project</div><div class="badget">4</div></a></li></ul></div></section><div class="m_widget tagcloud"><div class="header">Tags</div><div class="content"><a href="/blog/tags/C/" style="font-size:14px;color:grey">C#</a> <a href="/blog/tags/OpenDataDiscovery-org/" style="font-size:15.2px;color:#666">OpenDataDiscovery.org</a> <a href="/blog/tags/arcgis/" style="font-size:18.8px;color:#1a1a1a">arcgis</a> <a href="/blog/tags/arcobject/" style="font-size:14px;color:grey">arcobject</a> <a href="/blog/tags/geojson/" style="font-size:15.2px;color:#666">geojson</a> <a href="/blog/tags/gis/" style="font-size:20px;color:#000">gis</a> <a href="/blog/tags/javascript/" style="font-size:15.2px;color:#666">javascript</a> <a href="/blog/tags/landsat/" style="font-size:15.2px;color:#666">landsat</a> <a href="/blog/tags/leaflet/" style="font-size:16.4px;color:#4d4d4d">leaflet</a> <a href="/blog/tags/modis/" style="font-size:14px;color:grey">modis</a> <a href="/blog/tags/open-data/" style="font-size:17.6px;color:#333">open data</a> <a href="/blog/tags/openstreetmap/" style="font-size:14px;color:grey">openstreetmap</a> <a href="/blog/tags/project/" style="font-size:16.4px;color:#4d4d4d">project</a> <a href="/blog/tags/python/" style="font-size:16.4px;color:#4d4d4d">python</a> <a href="/blog/tags/remote-sensing/" style="font-size:17.6px;color:#333">remote sensing</a> <a href="/blog/tags/typescript/" style="font-size:16.4px;color:#4d4d4d">typescript</a></div></div></aside><script>setLoadingBarProgress(60)</script></div></div><footer id="footer" class="clearfix"><div class="social-wrapper"><a href="https://github.com/haoliangyu" class="social github" target="_blank" rel="external"><span class="icon icon-github"></span> </a><a href="/atom.xml" class="social rss" target="_blank" rel="external"><span class="icon icon-rss"></span></a></div><div>A blog built by Haoliang Yu</div></footer><script>setLoadingBarProgress(80)</script><script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script><script src="//cdn.bootcss.com/node-waves/0.7.5/waves.min.js"></script><script src="//cdn.bootcss.com/scrollReveal.js/3.3.2/scrollreveal.min.js"></script><script src="/blog/js/jquery.fitvids.js"></script><script>var GOOGLE_CUSTOM_SEARCH_API_KEY="",GOOGLE_CUSTOM_SEARCH_ENGINE_ID="",ALGOLIA_API_KEY="",ALGOLIA_APP_ID="",ALGOLIA_INDEX_NAME="",AZURE_SERVICE_NAME="",AZURE_INDEX_NAME="",AZURE_QUERY_KEY="",BAIDU_API_ID="",SEARCH_SERVICE="hexo",ROOT="/blog/";ROOT.endsWith("/")||(ROOT+="/")</script><script src="/blog/js/search.js"></script><script src="/blog/js/app.js"></script><script>setLoadingBarProgress(100)</script></body>